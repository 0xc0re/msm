_msm() {
	source "/etc/msm.conf"

	local base current options
	COMPREPLY=()
	
	current="${COMP_WORDS[$COMP_CWORD]}"
	base="${COMP_WORDS[1]}"
	
	if [[ $COMP_CWORD -gt 1 ]]; then
		case "$base" in
			stop|restart)
				if [[ $COMP_CWORD == 2 ]]; then
					options="now"
				fi
				;;
			server)
				if [[ $COMP_CWORD == 2 ]]; then
					options="list create delete rename"
				else
					case ${COMP_WORDS[2]} in
						delete|rename)
							if [[ $COMP_CWORD == 3 ]]; then
								options=$(ls -1 $SERVER_STORAGE_PATH)
							fi
							;;
					esac
				fi
				;;
			jargroup)
				if [[ $COMP_CWORD == 2 ]]; then
					options="list create delete rename changeurl getlatest"
				else
					case ${COMP_WORDS[2]} in
						delete|rename|changeurl|getlatest)
							if [[ $COMP_CWORD == 3 ]]; then
								options=$(ls -1 $JAR_STORAGE_PATH)
							fi
							;;
					esac
				fi
				;;
			*)
				# Server options
				if [ -e $SERVER_STORAGE_PATH/${COMP_WORDS[2]} ]; then
					options="start stop restart status connected worlds logroll backup jar wl whitelist bl blacklist op operator gm gamemode kick say time tdf toggledownfall save cmd cmdlog"
				fi
				;;
		esac
	else
		local servers=$(ls -1 $SERVER_STORAGE_PATH)
		options="help start stop restart server jargroup $servers"
	fi
	
	COMPREPLY=( $(compgen -W "${options}" -- ${current}) )
	return 0
}

complete -F _msm msm