_msm() {
	source "/etc/msm.conf"

	local base current options
	COMPREPLY=()
	
	current="${COMP_WORDS[$COMP_CWORD]}"
	base="${COMP_WORDS[1]}"
	
	if [[ $COMP_CWORD -gt 1 ]]; then
		case "$base" in
			start)
				# Do nothing there is no more
				;;
			stop)
				if [[ $COMP_CWORD == 2 ]]; then
					options="now"
				fi
				;;
			restart)
				if [[ $COMP_CWORD == 2 ]]; then
					options="now"
				fi
				;;
			server)
				if [[ $COMP_CWORD == 2 ]]; then
					options="list create delete rename"
				fi
				;;
			jargroup)
				if [[ $COMP_CWORD == 2 ]]; then
					options="list create delete rename changeurl getlatest"
				fi
				;;
			*)
				# Server options
				if [ -e $SERVER_STORAGE_PATH/${COMP_WORDS[2]} ]; then
					options="start stop restart status connected worlds logroll backup jar wl whitelist bl blacklist op operator gm gamemode kick say time tdf toggledownfall save cmd cmdlog"
				fi
				;;
		esac
	else
		local servers=$(ls -1 $SERVER_STORAGE_PATH)
		options="help start stop restart server jargroup $servers"
	fi
	
	COMPREPLY=( $(compgen -W "${options}" -- ${current}) )
	return 0
}

complete -F _msm msm